from selenium import webdriver
from selenium.webdriver.edge.options import Options
from selenium.webdriver.common.by import By
import io
import sys

sys.stdout = io.TextIOWrapper(sys.stdout.buffer,encoding='utf8')
options = Options()
# options.binary_location = r"C:\Program Files (x86)\Microsoft\Edge Beta\Application\msedge.exe"
driver = webdriver.Edge(options = options)


#collect year-month links
driver.get("https://www.cvedetails.com/browse-by-date.php")
target_year_list=["2018","2019","2020","2021","2022"]
# target_year_list=["2019","2020","2021","2022"]

pages_year=[]
year_banner= driver.find_element(By.CLASS_NAME, "stats")
year_contents=year_banner.find_element(By.TAG_NAME,"tbody").find_elements(By.TAG_NAME,"tr")
for year in year_contents:
    if year.find_element(By.TAG_NAME,"th").text in target_year_list:
        pages_month=[]
        
        months=year.find_elements(By.TAG_NAME,"td")
        for month in months:
            try:
                res=month.find_element(By.TAG_NAME,"a")
                pages_month.append([res.text,res.get_attribute("href")])
            except:
                continue

        pages_year.append([year.find_element(By.TAG_NAME,"th").text,pages_month])

    
   
for year in pages_year:
    for month in year[1]:
        driver.get(month[1])

        # if month[0]!="December":
        #     continue

        with open("./cve_data/"+year[0]+"_"+month[0]+".log", mode='a',encoding='utf-8') as filename:
            pagebanner = driver.find_element(By.ID, "pagingb")
            pages=pagebanner.find_elements(By.TAG_NAME, "a")
            pages_list=[]

            for page in pages:
                page_addr=page.get_attribute('href')
                pages_list.append(page_addr)

            for page_addr in pages_list:
                driver.get(page_addr)

                contentbanner=driver.find_element_by_xpath("//div[@id='pagingt']/following-sibling::div/following-sibling::div")
                showcontent= contentbanner.find_elements(By.TAG_NAME, "a")[0]

                showcontent.click()

                content=driver.find_element_by_id("downloadoverlaydivtxtarea")

                filename.write(content.get_attribute('value'))
    



